<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>A-Frame Car Test</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
</head>
<body>
  <a-scene>
    <a-entity camera wasd-controls look-controls position="0 7 0" id="camera"></a-entity>

    <a-entity oculus-touch-controls="hand: left" id="leftController" class="controller"></a-entity>

    <a-plane color="white" width="10" height="20" rotation="-90 0 0" position="-5 -0.1 0"></a-plane>
     <a-plane color="black" width="10" height="20" rotation="-90 0 0" position="5 -0.1 0"></a-plane>


    <a-entity id="car" gltf-model="url(models/bmw-326/scene.gltf)" position="0 0 -5" rotation="0 180 0" scale="0.02 0.02 0.02"></a-entity>

    <script>
      AFRAME.registerComponent('car-controls', {
          init: function () {
            this.el.sceneEl.addEventListener('thumbstickmoved', this.handleThumbstick.bind(this));
              this.el.addEventListener('axismove', this.brake.bind(this));
              this.car = document.getElementById('car');
              this.speed = 0;
              this.maxSpeed = 0.15;
              this.acceleration = 0.005;
              this.brakingForce = 0.02;
              this.slowSpeed = this.maxSpeed * 0.5; // slowSpeed fÃ¼r nicht-Rennstrecke
               this.raycaster = new THREE.Raycaster();
               this.downwardDirection = new THREE.Vector3(0, -1, 0);
               this.whiteColor = new THREE.Color("white");
          },
          tick: function () {

             const carPosition = this.car.getAttribute('position');

             this.raycaster.set(new THREE.Vector3(carPosition.x, carPosition.y, carPosition.z), this.downwardDirection);

             const intersects = this.raycaster.intersectObjects(this.el.sceneEl.querySelectorAll('a-plane'));

            if (intersects.length > 0) {
                 const intersectedObject = intersects[0].object;
                 const intersectedColor = intersectedObject.material.color;

                   if(intersectedColor.equals(this.whiteColor)){
                      this.maxSpeed = this.slowSpeed;
                  } else {
                      this.maxSpeed = 0.15;
                  }
                }
          },
         handleThumbstick: function (evt) {
              const hand = evt.target.getAttribute('oculus-touch-controls').hand;
              if (hand === 'left') {
                  const thumbstickX = evt.detail.x;
                  const thumbstickY = evt.detail.y;

                  if (thumbstickY < 0) {
                      this.speed = Math.min(this.speed + this.acceleration, this.maxSpeed);
                  }

                  const carRotationY = this.car.getAttribute('rotation').y * Math.PI / 180;

                  const movementX = (thumbstickX * this.speed) * Math.cos(carRotationY) - (-thumbstickY * this.speed) * Math.sin(carRotationY);
                  const movementZ = (thumbstickX * this.speed) * Math.sin(carRotationY) + (-thumbstickY * this.speed) * Math.cos(carRotationY);

                  const currentPosition = this.car.getAttribute('position');
                  this.car.setAttribute('position', {
                      x: currentPosition.x + movementX,
                      y: currentPosition.y,
                      z: currentPosition.z + movementZ
                  });

                  const rotationSpeed = 0.5;
                  const turnAmount = -thumbstickX * rotationSpeed;
                  const currentRotation = this.car.getAttribute('rotation');
                  this.car.setAttribute('rotation', {
                      x: currentRotation.x,
                      y: currentRotation.y + turnAmount,
                      z: currentRotation.z,
                  });
              }
          },
          brake: function (evt) {
              const hand = evt.target.getAttribute('oculus-touch-controls').hand;
              if (hand === 'left' && evt.detail.axis[3] < -0.8) {
                  this.speed = Math.max(0, this.speed - this.brakingForce);
              }
          }
      });


      document.getElementById('leftController').setAttribute('car-controls', '');
    
    </script>
  </a-scene>
</body>
</html>