<!DOCTYPE html>
<html>
<head>
    <title>Oculus Quest Car Drive</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="car-controller.js"></script>
    <script>
        AFRAME.registerComponent('camera-control', {
             schema: {
                offsetDistance: { type: 'number', default: 20 },
                offsetY: {type: 'number', default: 8},
                cameraAngle: { type: 'number', default: -0.2}
            },
            init: function() {
                const car = document.getElementById('car');
                 const cameraRig = document.getElementById('cameraRig');
                const camera = this.el;


                if(car && cameraRig) {
                    const carPosition = car.object3D.position;

                     const offset = new THREE.Vector3(0, this.data.offsetY, this.data.offsetDistance);

                     // initial camera position
                    const initialPosition = new THREE.Vector3().copy(carPosition).add(offset.applyQuaternion(car.object3D.quaternion));
                    cameraRig.object3D.position.copy(initialPosition);


                    //initial rotation of camera rig
                    const initialRotation = car.object3D.rotation.clone();
                     initialRotation.x += this.data.cameraAngle
                   cameraRig.object3D.rotation.copy(initialRotation)

                }
            },
            tick: function () {
                const car = document.getElementById('car');
               const cameraRig = document.getElementById('cameraRig');
                const rightController = document.getElementById('right-controller'); // Get controller using ID

                if (car && rightController && rightController.components['oculus-quest-controls'] && cameraRig) {
                   const carPosition = car.object3D.position;

                    // camera following logic
                   const offset = new THREE.Vector3(0, this.data.offsetY, this.data.offsetDistance);
                    const desiredPosition = new THREE.Vector3().copy(carPosition).add(offset.applyQuaternion(car.object3D.quaternion));
                    cameraRig.object3D.position.lerp(desiredPosition,0.05);


                    // camera rotation based on right controller
                    const rightJoystick = rightController.components['oculus-quest-controls'].thumbstick
                    cameraRig.object3D.rotation.y -= rightJoystick.x*2*Math.PI/360 * 0.5
                }
            }
        });
    </script>
</head>
<body>
<a-scene>
    <a-entity id="cameraRig" camera-control >
        <a-entity id="camera" camera look-controls="enabled:false"></a-entity>
    </a-entity>

    <a-plane
            rotation="-90 0 0"
            width="100"
            height="100"
            color="#777"
            shadow
    ></a-plane>

    <a-entity id="car" gltf-model="url(models/bmw-326/scene.gltf)" position="0 0.2 0" rotation="0 180 0" scale="0.03 0.03 0.03" shadow car-controller>
    </a-entity>

    <a-entity oculus-quest-controls="hand:left;" id="left-controller" left-controller></a-entity>
    <a-entity oculus-quest-controls="hand:right;" id="right-controller" right-controller></a-entity>

    <a-entity light="type: ambient; color: #BBB"></a-entity>
    <a-entity light="type: directional; color: #FFF; intensity: 0.6" position="-0.5 1 1"></a-entity>
</a-scene>
</body>
</html>